<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Rei da Matem√°tica</title>
<style>
  :root{
    --bg:#071023;
    --panel:#0b1a2b;
    --accent:#6ad1ff;
    --hp:#2ecc71;
    --danger:rgba(255,0,0,0.18);
  }
  html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,Arial;color:#eaf6ff;background:linear-gradient(180deg,var(--bg), #031022);display:flex;align-items:center;justify-content:center}
  .wrap{width:980px;max-width:96vw;padding:18px;border-radius:12px;background:linear-gradient(180deg,var(--panel), rgba(8,16,28,0.9));box-shadow:0 10px 40px rgba(0,0,0,0.6);position:relative;overflow:hidden}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  h1{font-size:1.2rem;margin:0;color:var(--accent)}
  .hud{display:flex;gap:12px;align-items:center}
  .stat{background:rgba(255,255,255,0.03);padding:8px 10px;border-radius:10px;min-width:140px}
  .bar{height:12px;background:#092233;border-radius:8px;overflow:hidden;margin-top:6px;border:1px solid rgba(255,255,255,0.03)}
  .bar .fill{height:100%;background:var(--hp);width:100%;transition:width 260ms linear}
  .main{display:grid;grid-template-columns:1fr 360px;gap:16px;align-items:start}
  .battle{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:14px;border-radius:10px;min-height:360px;position:relative}
  .log{height:120px;overflow:auto;background:rgba(0,0,0,0.14);padding:8px;border-radius:8px;margin-top:10px;font-size:13px}
  .enemy-box{display:flex;align-items:center;gap:12px}
  .char{width:86px;height:86px;border-radius:10px;background:linear-gradient(180deg,#ff7a7a,#b02b2b);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:22px;box-shadow:0 8px 20px rgba(176,43,43,0.18)}
  .hero{width:86px;height:86px;border-radius:10px;background:linear-gradient(180deg,#7ad1ff,#2b8fb0);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:22px;box-shadow:0 8px 20px rgba(43,143,176,0.12)}
  .panel-right{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px}
  .problem{font-size:22px;font-weight:700;margin:8px 0}
  .controls{display:flex;gap:8px;align-items:center}
  input.answer{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:inherit;font-size:16px}
  button{padding:10px 12px;border-radius:8px;border:none;background:var(--accent);color:#012737;font-weight:700;cursor:pointer}
  small{opacity:0.85;font-size:12px}
  .flash { position:absolute; inset:0; pointer-events:none; background:transparent; transition:background 180ms linear; z-index:20 }
  .flash.red { background: rgba(255,0,0,0.18); }
  .difficulty{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .difficulty button{background:rgba(255,255,255,0.03);color:var(--accent);padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
  .bottom-row{display:flex;gap:8px;margin-top:12px;align-items:center}
  footer{margin-top:10px;font-size:12px;color:rgba(234,246,255,0.6)}
  .small-muted{font-size:12px;opacity:0.8}
  .enemy-name{font-weight:800;color:#ffd3d3}
  .center{display:flex;align-items:center;justify-content:center}
  /* Start and Game Over overlays */
  .overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:50; }
  #startOverlay, #gameOverOverlay { background: rgba(0,0,0,0.85); }
  .panel { background:linear-gradient(180deg,#071728,#02121a); padding:22px; border-radius:12px; width:480px; max-width:92vw; color:#eaf6ff; text-align:center; box-shadow:0 18px 60px rgba(0,0,0,0.6) }
  .panel h2{margin:0 0 12px 0; color:var(--accent)}
  .panel .choices{display:flex;gap:10px;justify-content:center;margin-top:12px;flex-wrap:wrap}
  .panel button.opt{background:transparent;border:1px solid rgba(255,255,255,0.08);padding:10px 14px;border-radius:10px;color:#cfe1ff;cursor:pointer}
  .panel button.opt.selected{border-color:var(--accent); box-shadow:0 6px 18px rgba(13,110,253,0.12); background: rgba(13,110,253,0.06); color:var(--accent)}
  .panel .startBtn{margin-top:16px;padding:12px 18px;background:var(--accent);color:#012737;font-weight:800;border-radius:10px;border:none;cursor:pointer}
  #gameOverOverlay .panel { width:420px }
</style>
</head>
<body>
  <div class="wrap" id="wrap">
    <div class="flash" id="flash"></div>

    <header>
      <h1>Rei da Matem√°tica</h1>
      <div class="hud">
        <div class="stat">
          <div>Her√≥i</div>
          <div class="bar"><div id="hpFill" class="fill"></div></div>
          <div class="small-muted">HP: <span id="hpText">100</span> / <span id="maxHp">100</span></div>
        </div>
        <div class="stat">
          <div>Rodada</div>
          <div style="margin-top:6px;font-weight:800" id="roundDisplay">1</div>
        </div>
      </div>
    </header>

    <main class="main">
      <section class="battle">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="enemy-box">
            <div class="char" id="enemyAvatar">E</div>
            <div>
              <div class="enemy-name" id="enemyName">‚Äî</div>
              <div class="small-muted">HP <span id="enemyHp">0</span></div>
            </div>
          </div>

          <div class="center">
            <div style="text-align:center">
              <div class="small-muted">Resolva a conta para atacar</div>
              <div id="resultInfo" class="small-muted"></div>
            </div>
          </div>

          <div class="enemy-box">
            <div>
              <div style="opacity:0.9">Her√≥i</div>
              <div class="small-muted">Ataque ao resolver: <span id="atkValue">10</span></div>
            </div>
            <div class="hero">H</div>
          </div>
        </div>

        <div style="margin-top:18px">
          <div class="problem" id="problemText">Carregando...</div>

          <div class="controls">
            <input id="answer" class="answer" autocomplete="off" inputmode="numeric" />
            <button id="submitBtn">Confirmar</button>
            <button id="skipBtn" title="Pular (leva dano)">Pular</button>
          </div>

          <div class="bottom-row">
            <div class="small-muted">Tempo por conta: <strong id="timerDisplay">--</strong>s</div>
            <div style="margin-left:14px" class="small-muted">Erros permitidos: <strong id="mistakes">3</strong></div>
          </div>

          <div class="log" id="log"></div>
        </div>
      </section>

      <aside class="panel-right">
        <div>
          <div style="font-weight:800">Configura√ß√µes de dificuldade</div>
          <div class="difficulty" id="difficultyBtns">
            <button data-diff="easy">F√°cil</button>
            <button data-diff="normal" class="selected">Normal</button>
            <button data-diff="hard">Dif√≠cil</button>
            <button data-diff="extreme">Extremo</button>
          </div>

          <div style="margin-top:12px">
            <div style="font-weight:800">Op√ß√µes</div>
            <div class="small-muted" style="margin-top:8px">Opera√ß√µes: + - √ó √∑</div>
            <div class="small-muted" style="margin-top:6px">Multiplica√ß√£o e divis√£o aparecem com prioridade em n√≠veis avan√ßados</div>
          </div>

          <div style="margin-top:12px">
            <div style="font-weight:800">Progresso</div>
            <div class="small-muted">Pontua√ß√£o: <strong id="score">0</strong></div>
            <div class="small-muted" style="margin-top:6px">Acertos seguidos: <strong id="streak">0</strong></div>
          </div>

          <div style="margin-top:12px">
            <div style="font-weight:800">Regras r√°pidas</div>
            <ul style="padding-left:18px;margin:8px 0 0 0;">
              <li>Errou ‚Üí leva dano</li>
              <li>Pular tamb√©m causa dano</li>
              <li>Tela pisca vermelho ao sofrer dano</li>
            </ul>
          </div>

          <div style="margin-top:14px">
            <button id="startBtn">Iniciar Jogo</button>
            <button id="newRoundBtn" style="margin-left:6px">Nova Rodada</button>
          </div>

        </div>
      </aside>
    </main>

    <footer>
      <div class="small-muted">Dica: use teclado para digitar respostas e Enter para confirmar.</div>
    </footer>
  </div>

  <!-- Start overlay: choose difficulty before starting -->
  <div id="startOverlay" class="overlay" style="display:flex">
    <div class="panel">
      <h2>Escolha a dificuldade</h2>
      <p>Selecione um n√≠vel para come√ßar o jogo. Multiplica√ß√£o e divis√£o ficam mais frequentes em n√≠veis avan√ßados.</p>
      <div class="choices" id="startChoices">
        <button class="opt" data-diff="easy">F√°cil</button>
        <button class="opt selected" data-diff="normal">Normal</button>
        <button class="opt" data-diff="hard">Dif√≠cil</button>
        <button class="opt" data-diff="extreme">Extremo</button>
      </div>
      <div style="margin-top:14px">
        <button id="startGameBtn" class="startBtn">Come√ßar</button>
      </div>
    </div>
  </div>

  <!-- Game Over overlay -->
  <div id="gameOverOverlay" class="overlay" style="display:none">
    <div class="panel">
      <h2>Game Over</h2>
      <p id="gameOverText">Voc√™ foi derrotado.</p>
      <div style="margin-top:12px">
        <button id="retryBtn" class="startBtn">Recome√ßar</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // Elements
  const problemText = document.getElementById('problemText');
  const answerInput = document.getElementById('answer');
  const submitBtn = document.getElementById('submitBtn');
  const skipBtn = document.getElementById('skipBtn');
  const logEl = document.getElementById('log');
  const hpFill = document.getElementById('hpFill');
  const hpText = document.getElementById('hpText');
  const enemyHpText = document.getElementById('enemyHp');
  const enemyNameEl = document.getElementById('enemyName');
  const timerDisplay = document.getElementById('timerDisplay');
  const mistakesEl = document.getElementById('mistakes');
  const atkValueEl = document.getElementById('atkValue');
  const scoreEl = document.getElementById('score');
  const streakEl = document.getElementById('streak');
  const roundDisplay = document.getElementById('roundDisplay');
  const flash = document.getElementById('flash');

  const startOverlay = document.getElementById('startOverlay');
  const startChoices = document.getElementById('startChoices');
  const startGameBtn = document.getElementById('startGameBtn');
  const startBtn = document.getElementById('startBtn');
  const newRoundBtn = document.getElementById('newRoundBtn');
  const gameOverOverlay = document.getElementById('gameOverOverlay');
  const retryBtn = document.getElementById('retryBtn');
  const difficultyBtns = document.getElementById('difficultyBtns');

  // State
  let hero = { hp: 100, maxHP: 100, atk: 10 };
  let enemy = null;
  let round = 1;
  let score = 0;
  let streak = 0;
  let mistakesAllowed = 3;
  let mistakesLeft = mistakesAllowed;
  let timeLimit = 12;
  let timer = null;
  let timeLeft = timeLimit;
  let currentProblem = null;
  let awaiting = false;
  let difficulty = 'normal';
  let gameStarted = false;
  let gameOver = false;

  // Helpers
  function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function log(msg){ const p = document.createElement('div'); p.textContent = msg; logEl.prepend(p); }
  function setHP(h){ hero.hp = Math.max(0, Math.min(hero.maxHP, h)); hpText.textContent = Math.round(hero.hp); hpFill.style.width = (hero.hp/hero.maxHP*100)+'%'; }
  function setEnemy(e){ enemy = e; enemyHpText.textContent = Math.max(0, Math.round(enemy.hp)); enemyNameEl.textContent = enemy.name; }

  // Flash red when damaged
  let flashTimer = null;
  function flashRed(duration = 220){
    flash.classList.add('red');
    if (flashTimer) clearTimeout(flashTimer);
    flashTimer = setTimeout(()=> flash.classList.remove('red'), duration);
  }

  // Enemy creation (boss every 10 rounds)
  function createEnemy(isBoss=false){
    if (isBoss){
      const baseHP = 200 + (round-1) * 40;
      const baseDmg = 18 + Math.floor(round * 2.5);
      const names = ['Goblin King','Skeletal Lord','Witch Matron','Guardian','Warbeast'];
      const name = names[rand(0,names.length-1)];
      return { name: name, hp: baseHP, maxHP: baseHP, atk: baseDmg, boss:true };
    }
    const baseHP = 18 + round * 6;
    const baseDmg = 6 + Math.floor(round * 1.6);
    const names = ['Goblin','Ladr√£o','Esqueleto','Bruxa','Carcereiro'];
    const name = names[rand(0,names.length-1)];
    return { name: name, hp: baseHP, maxHP: baseHP, atk: baseDmg, boss:false };
  }

  // Problem generator (with * and /)
  function generateProblem(){
    let opWeights;
    if (difficulty === 'easy') { opWeights = { '+':4,'-':3,'*':1,'/':1 }; timeLimit = 14; }
    else if (difficulty === 'normal') { opWeights = { '+':3,'-':3,'*':2,'/':2 }; timeLimit = 12; }
    else if (difficulty === 'hard') { opWeights = { '+':2,'-':2,'*':3,'/':3 }; timeLimit = 10; }
    else { opWeights = { '+':1,'-':1,'*':4,'/':4 }; timeLimit = 8; }

    const ops = ['+','-','*','/'];
    const opsCount = (difficulty === 'easy') ? 1 : (difficulty === 'normal' ? rand(1,2) : rand(2,3));
    const chosenOps = [];
    for (let i=0;i<opsCount;i++){
      const pool = [];
      for (const o of ops) for (let k=0;k<opWeights[o];k++) pool.push(o);
      chosenOps.push(pool[rand(0,pool.length-1)]);
    }

    const nums = [];
    function numRangeFor(op){
      if (op === '*' || op === '/') {
        if (difficulty === 'easy') return [2,6];
        if (difficulty === 'normal') return [2,9];
        if (difficulty === 'hard') return [3,12];
        return [4,18];
      } else {
        if (difficulty === 'easy') return [0,12];
        if (difficulty === 'normal') return [0,25];
        if (difficulty === 'hard') return [-12,45];
        return [-20,80];
      }
    }

    for (let i=0;i<chosenOps.length+1;i++){
      if (i === 0){
        const [min,max] = numRangeFor(chosenOps[0] || '+');
        nums.push(rand(min,max));
      } else {
        const op = chosenOps[i-1];
        const [min,max] = numRangeFor(op);
        if (op === '/'){
          const divisor = rand(Math.max(1,min), Math.max(1,max));
          if (nums[i-1] === 0) nums[i-1] = divisor * rand(1,4);
          if (nums[i-1] % divisor !== 0){
            nums[i-1] = divisor * Math.max(1, Math.floor(Math.abs(nums[i-1]) / divisor));
            if (nums[i-1] === 0) nums[i-1] = divisor * 1;
          }
          nums.push(divisor);
        } else {
          nums.push(rand(min,max));
        }
      }
    }

    let tokens = [];
    for (let i=0;i<nums.length;i++){
      tokens.push(String(nums[i]));
      if (i < chosenOps.length) tokens.push(chosenOps[i]);
    }
    if (chosenOps.length >= 2 && Math.random() < 0.45){
      tokens = ['('].concat(tokens.slice(0,3)).concat([')']).concat(tokens.slice(3));
    }
    const exprStr = tokens.join(' ');
    let value;
    try { value = Function('"use strict"; return (' + exprStr + ')')(); } catch (e){ value = 0; }
    if (Math.abs(Math.round(value) - value) < 1e-9) value = Math.round(value);
    const answerType = (Math.abs(value - Math.round(value)) < 1e-9) ? 'int' : 'float';
    return { expr: exprStr, value: value, answerType, timeLimit };
  }

  // Next problem lifecycle
  function nextProblem(){
    if (!enemy || enemy.hp <= 0){
      if ((round % 10) === 0){
        setEnemy(createEnemy(true));
        log(`üî• Chefe aparece na rodada ${round}!`);
      } else {
        setEnemy(createEnemy(false));
      }
    }
    currentProblem = generateProblem();
    problemText.textContent = currentProblem.expr;
    timeLeft = currentProblem.timeLimit;
    timerDisplay.textContent = timeLeft.toFixed(1);
    answerInput.value = '';
    answerInput.focus();
    awaiting = true;
    if (timer) clearInterval(timer);
    timer = setInterval(()=>{
      timeLeft -= 0.2;
      timerDisplay.textContent = Math.max(0, timeLeft.toFixed(1));
      if (timeLeft <= 0){
        clearInterval(timer);
        timer = null;
        awaiting = false;
        onWrong('Tempo esgotado');
      }
    },200);
  }

  // On correct
  function onCorrect(){
    if (!awaiting) return;
    awaiting = false;
    if (timer){ clearInterval(timer); timer = null; }
    const base = hero.atk;
    const roundBonus = Math.floor((round - 1) * 0.5);
    const streakBonus = Math.floor(streak * 0.4);
    const dmg = base + roundBonus + streakBonus;
    const prevHP = enemy.hp;
    enemy.hp = Math.max(0, enemy.hp - dmg);
    log(`‚úîÔ∏è Correto! Voc√™ causou ${dmg} de dano ao ${enemy.name}.`);
    score += 10 + Math.floor(dmg);
    streak++;
    scoreEl.textContent = score;
    streakEl.textContent = streak;
    enemyHpText.textContent = Math.max(0, Math.round(enemy.hp));
    if (enemy.hp <= 0){
      log(`üíÄ Inimigo derrotado! Voc√™ ganha 30 pontos.`);
      score += 30;
      scoreEl.textContent = score;
      enemy = null;
      setTimeout(()=> {
        mistakesLeft = Math.min(mistakesAllowed, mistakesLeft + 1);
        mistakesEl.textContent = mistakesLeft;
        round++;
        roundDisplay.textContent = round;
        hero.atk = Math.round(hero.atk * 1.04);
        atkValueEl.textContent = hero.atk;
        nextProblem();
      }, 800);
      return;
    }
    setTimeout(nextProblem, 600);
  }

  // On wrong or skip
  function onWrong(reason){
    if (awaiting && timer){ clearInterval(timer); timer = null; }
    awaiting = false;
    streak = 0; streakEl.textContent = streak;
    mistakesLeft--;
    mistakesEl.textContent = mistakesLeft;
    const baseDmg = enemy ? enemy.atk : Math.max(6, Math.floor(round * 1.6));
    const damage = Math.max(4, Math.floor(baseDmg * (1 + (Math.random()*0.6))));
    setHP(hero.hp - damage);
    flashRed(260);
    log(`‚ùå ${reason}. Voc√™ recebeu ${damage} de dano.`);
    if (hero.hp <= 0){
      log('üí• Voc√™ morreu.');
      triggerGameOver();
      return;
    }
    if (mistakesLeft <= 0){
      log('üîî Muitas falhas ‚Äî penalidade aplicada.');
      const extra = 6 + round;
      setHP(hero.hp - extra);
      mistakesLeft = mistakesAllowed; mistakesEl.textContent = mistakesLeft;
      if (hero.hp <= 0){ triggerGameOver(); return; }
    }
    setTimeout(nextProblem, 700);
  }

  function triggerGameOver(){
    awaiting = false;
    if (timer){ clearInterval(timer); timer = null; }
    gameOver = true;
    gameOverOverlay.style.display = 'flex';
    document.getElementById('gameOverText').textContent = `Voc√™ chegou at√© a rodada ${round}. Pontos: ${score}`;
  }

  // Evaluate answer
  function evaluateAnswer(input){
    if (!currentProblem) return false;
    const expected = currentProblem.value;
    const trimmed = String(input).trim();
    if (trimmed === '') return false;
    const normalized = trimmed.replace(',', '.');
    const num = Number(normalized);
    if (Number.isNaN(num)) return false;
    if (currentProblem.answerType === 'int'){
      return Math.round(num) === Math.round(expected);
    } else {
      return Math.abs(num - expected) <= Math.max(0.01, Math.abs(expected)*0.01);
    }
  }

  // UI handlers
  submitBtn.addEventListener('click', ()=>{
    if (!awaiting) return;
    const val = answerInput.value;
    if (evaluateAnswer(val)) onCorrect(); else onWrong('Resposta incorreta');
  });
  answerInput.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter'){ submitBtn.click(); }
  });
  skipBtn.addEventListener('click', ()=> {
    if (!awaiting) return;
    onWrong('Pulou a conta');
  });

  // Start overlay interactions
  startChoices.addEventListener('click', (ev)=>{
    const b = ev.target.closest('button.opt');
    if (!b) return;
    startChoices.querySelectorAll('button.opt').forEach(x=>x.classList.remove('selected'));
    b.classList.add('selected');
    difficulty = b.dataset.diff;
    difficultyBtns.querySelectorAll('button[data-diff]').forEach(btn => {
      btn.classList.toggle('selected', btn.dataset.diff === difficulty);
    });
  });
  startGameBtn.addEventListener('click', ()=>{
    startOverlay.style.display = 'none';
    applyDifficultySettings(difficulty);
    startGame();
  });

  difficultyBtns.addEventListener('click', (ev)=>{
    const b = ev.target.closest('button[data-diff]');
    if (!b) return;
    difficulty = b.dataset.diff;
    difficultyBtns.querySelectorAll('button[data-diff]').forEach(x=>x.classList.remove('selected'));
    b.classList.add('selected');
    log(`üîß Dificuldade ajustada para: ${difficulty}`);
    applyDifficultySettings(difficulty);
  });

  startBtn.addEventListener('click', ()=>{
    if (!gameStarted){
      startOverlay.style.display = 'none';
      applyDifficultySettings(difficulty);
      startGame();
    }
  });

  // FIXED retryBtn listener: resets state and restarts immediately
  retryBtn.addEventListener('click', () => {
    // close overlay
    gameOver = false;
    gameOverOverlay.style.display = 'none';

    // reset main state
    score = 0;
    scoreEl.textContent = score;
    streak = 0;
    streakEl.textContent = streak;
    mistakesLeft = mistakesAllowed;
    mistakesEl.textContent = mistakesLeft;

    round = 1;
    roundDisplay.textContent = round;
    hero = { hp: 100, maxHP: 100, atk: 10 };
    setHP(hero.hp);
    atkValueEl.textContent = hero.atk;

    // clear timers and problem/enemy state
    if (timer) { clearInterval(timer); timer = null; }
    currentProblem = null;
    awaiting = false;
    enemy = null;

    // ensure overlays hidden
    startOverlay.style.display = 'none';
    gameOverOverlay.style.display = 'none';

    // apply difficulty and start game
    applyDifficultySettings(difficulty);
    setEnemy(createEnemy((round % 10) === 0));
    nextProblem();

    gameStarted = true;
    log('üîÑ Reiniciando jogo pelo Game Over. Boa sorte!');
  });

  newRoundBtn.addEventListener('click', ()=>{
    if (!gameStarted) return;
    round++;
    roundDisplay.textContent = round;
    hero.atk = Math.round(hero.atk * 1.04);
    atkValueEl.textContent = hero.atk;
    setEnemy(createEnemy((round % 10) === 0));
    nextProblem();
    log('üîÅ Nova rodada manual iniciada.');
  });

  function startGame(){
    gameStarted = true;
    gameOver = false;
    resetRun();
    setEnemy(createEnemy((round % 10) === 0));
    nextProblem();
    log('‚ñ∂Ô∏è Jogo iniciado. Boa sorte!');
  }

  function resetRun(){
    hero = { hp:100, maxHP:100, atk:10 };
    setHP(hero.hp);
    score = 0; scoreEl.textContent = score;
    streak = 0; streakEl.textContent = streak;
    mistakesLeft = mistakesAllowed; mistakesEl.textContent = mistakesLeft;
    round = 1; roundDisplay.textContent = round;
    enemy = null;
    logEl.innerHTML = '';
    atkValueEl.textContent = hero.atk;
  }

  function setEnemy(e){
    enemy = e;
    enemyHpText.textContent = Math.max(0, Math.round(enemy.hp));
    enemyNameEl.textContent = enemy.name + (enemy.boss ? ' (CHEFE)' : '');
    if (enemy.boss){
      flashRed(600);
      log(`‚öîÔ∏è CHEFE: ${enemy.name} ‚Äî HP: ${enemy.maxHP}, Dano: ${enemy.atk}`);
    }
  }

  function applyDifficultySettings(diff){
    if (diff === 'easy'){ mistakesAllowed = 4; }
    else if (diff === 'normal'){ mistakesAllowed = 3; }
    else if (diff === 'hard'){ mistakesAllowed = 2; }
    else { mistakesAllowed = 1; }
    mistakesLeft = mistakesAllowed; mistakesEl.textContent = mistakesLeft;
  }

  // init UI
  setHP(hero.hp);
  mistakesEl.textContent = mistakesLeft;
  atkValueEl.textContent = hero.atk;
  scoreEl.textContent = score;
  streakEl.textContent = streak;
  roundDisplay.textContent = round;

  // Expose debug helpers
  window._nextProblem = nextProblem;
  window._damageTest = ()=>{ setHP(hero.hp - 12); flashRed(300); };

})();
</script>
</body>
</html>
